(()=>{var ge=Object.defineProperty;var ye=(e,t,n)=>t in e?ge(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var C=(e,t,n)=>(ye(e,typeof t!="symbol"?t+"":t,n),n);var N=(e,t,n)=>new Promise((s,r)=>{var o=_=>{try{u(n.next(_))}catch(f){r(f)}},d=_=>{try{u(n.throw(_))}catch(f){r(f)}},u=_=>_.done?s(_.value):Promise.resolve(_.value).then(o,d);u((n=n.apply(e,t)).next())});function S(...e){e.length>=1?console.log("%c[\u5F48\u5E55\u5C71\u8108]","color: orange; font-weight: bold;",...e):console.log()}function G(e,t=3){return N(this,null,function*(){for(let n=0;n<t;n++)try{return yield e()}catch(s){S("Retry",n+1,e,s)}throw S("Failed",e),new Error("Failed")})}function X(e,t){return new Promise(n=>setTimeout(()=>n(t),e))}var W,h,Y,ve,q,Z,ee,be,B={},te=[],xe=/acit|ex(?:s|g|n|p|$)|rph|grid|ows|mnc|ntw|ine[ch]|zoo|^ord|itera/i;function P(e,t){for(var n in t)e[n]=t[n];return e}function ne(e){var t=e.parentNode;t&&t.removeChild(e)}function a(e,t,n){var s,r,o,d={};for(o in t)o=="key"?s=t[o]:o=="ref"?r=t[o]:d[o]=t[o];if(arguments.length>2&&(d.children=arguments.length>3?W.call(arguments,2):n),typeof e=="function"&&e.defaultProps!=null)for(o in e.defaultProps)d[o]===void 0&&(d[o]=e.defaultProps[o]);return M(e,d,s,r,null)}function M(e,t,n,s,r){var o={type:e,props:t,key:n,ref:s,__k:null,__:null,__b:0,__e:null,__d:void 0,__c:null,__h:null,constructor:void 0,__v:r==null?++Y:r};return r==null&&h.vnode!=null&&h.vnode(o),o}function F(e){return e.children}function z(e,t){this.props=e,this.context=t}function I(e,t){if(t==null)return e.__?I(e.__,e.__.__k.indexOf(e)+1):null;for(var n;t<e.__k.length;t++)if((n=e.__k[t])!=null&&n.__e!=null)return n.__e;return typeof e.type=="function"?I(e):null}function oe(e){var t,n;if((e=e.__)!=null&&e.__c!=null){for(e.__e=e.__c.base=null,t=0;t<e.__k.length;t++)if((n=e.__k[t])!=null&&n.__e!=null){e.__e=e.__c.base=n.__e;break}return oe(e)}}function ie(e){(!e.__d&&(e.__d=!0)&&q.push(e)&&!H.__r++||ee!==h.debounceRendering)&&((ee=h.debounceRendering)||Z)(H)}function H(){for(var e;H.__r=q.length;)e=q.sort(function(t,n){return t.__v.__b-n.__v.__b}),q=[],e.some(function(t){var n,s,r,o,d,u;t.__d&&(d=(o=(n=t).__v).__e,(u=n.__P)&&(s=[],(r=P({},o)).__v=o.__v+1,$(u,o,r,n.__n,u.ownerSVGElement!==void 0,o.__h!=null?[d]:null,s,d==null?I(o):d,o.__h),de(s,o),o.__e!=d&&oe(o)))})}function se(e,t,n,s,r,o,d,u,_,f){var i,m,c,l,p,A,y,v=s&&s.__k||te,w=v.length;for(n.__k=[],i=0;i<t.length;i++)if((l=n.__k[i]=(l=t[i])==null||typeof l=="boolean"?null:typeof l=="string"||typeof l=="number"||typeof l=="bigint"?M(null,l,null,null,l):Array.isArray(l)?M(F,{children:l},null,null,null):l.__b>0?M(l.type,l.props,l.key,null,l.__v):l)!=null){if(l.__=n,l.__b=n.__b+1,(c=v[i])===null||c&&l.key==c.key&&l.type===c.type)v[i]=void 0;else for(m=0;m<w;m++){if((c=v[m])&&l.key==c.key&&l.type===c.type){v[m]=void 0;break}c=null}$(e,l,c=c||B,r,o,d,u,_,f),p=l.__e,(m=l.ref)&&c.ref!=m&&(y||(y=[]),c.ref&&y.push(c.ref,null,l),y.push(m,l.__c||p,l)),p!=null?(A==null&&(A=p),typeof l.type=="function"&&l.__k===c.__k?l.__d=_=re(l,_,e):_=le(e,l,c,v,p,_),typeof n.type=="function"&&(n.__d=_)):_&&c.__e==_&&_.parentNode!=e&&(_=I(c))}for(n.__e=A,i=w;i--;)v[i]!=null&&(typeof n.type=="function"&&v[i].__e!=null&&v[i].__e==n.__d&&(n.__d=I(s,i+1)),ue(v[i],v[i]));if(y)for(i=0;i<y.length;i++)pe(y[i],y[++i],y[++i])}function re(e,t,n){for(var s,r=e.__k,o=0;r&&o<r.length;o++)(s=r[o])&&(s.__=e,t=typeof s.type=="function"?re(s,t,n):le(n,s,s,r,s.__e,t));return t}function le(e,t,n,s,r,o){var d,u,_;if(t.__d!==void 0)d=t.__d,t.__d=void 0;else if(n==null||r!=o||r.parentNode==null)e:if(o==null||o.parentNode!==e)e.appendChild(r),d=null;else{for(u=o,_=0;(u=u.nextSibling)&&_<s.length;_+=2)if(u==r)break e;e.insertBefore(r,o),d=o}return d!==void 0?d:r.nextSibling}function we(e,t,n,s,r){var o;for(o in n)o==="children"||o==="key"||o in t||R(e,o,null,n[o],s);for(o in t)r&&typeof t[o]!="function"||o==="children"||o==="key"||o==="value"||o==="checked"||n[o]===t[o]||R(e,o,t[o],n[o],s)}function ae(e,t,n){t[0]==="-"?e.setProperty(t,n):e[t]=n==null?"":typeof n!="number"||xe.test(t)?n:n+"px"}function R(e,t,n,s,r){var o;e:if(t==="style")if(typeof n=="string")e.style.cssText=n;else{if(typeof s=="string"&&(e.style.cssText=s=""),s)for(t in s)n&&t in n||ae(e.style,t,"");if(n)for(t in n)s&&n[t]===s[t]||ae(e.style,t,n[t])}else if(t[0]==="o"&&t[1]==="n")o=t!==(t=t.replace(/Capture$/,"")),t=t.toLowerCase()in e?t.toLowerCase().slice(2):t.slice(2),e.l||(e.l={}),e.l[t+o]=n,n?s||e.addEventListener(t,o?_e:ce,o):e.removeEventListener(t,o?_e:ce,o);else if(t!=="dangerouslySetInnerHTML"){if(r)t=t.replace(/xlink[H:h]/,"h").replace(/sName$/,"s");else if(t!=="href"&&t!=="list"&&t!=="form"&&t!=="tabIndex"&&t!=="download"&&t in e)try{e[t]=n==null?"":n;break e}catch(d){}typeof n=="function"||(n!=null&&(n!==!1||t[0]==="a"&&t[1]==="r")?e.setAttribute(t,n):e.removeAttribute(t))}}function ce(e){this.l[e.type+!1](h.event?h.event(e):e)}function _e(e){this.l[e.type+!0](h.event?h.event(e):e)}function $(e,t,n,s,r,o,d,u,_){var f,i,m,c,l,p,A,y,v,w,j,k=t.type;if(t.constructor!==void 0)return null;n.__h!=null&&(_=n.__h,u=t.__e=n.__e,t.__h=null,o=[u]),(f=h.__b)&&f(t);try{e:if(typeof k=="function"){if(y=t.props,v=(f=k.contextType)&&s[f.__c],w=f?v?v.props.value:f.__:s,n.__c?A=(i=t.__c=n.__c).__=i.__E:("prototype"in k&&k.prototype.render?t.__c=i=new k(y,w):(t.__c=i=new z(y,w),i.constructor=k,i.render=Ce),v&&v.sub(i),i.props=y,i.state||(i.state={}),i.context=w,i.__n=s,m=i.__d=!0,i.__h=[]),i.__s==null&&(i.__s=i.state),k.getDerivedStateFromProps!=null&&(i.__s==i.state&&(i.__s=P({},i.__s)),P(i.__s,k.getDerivedStateFromProps(y,i.__s))),c=i.props,l=i.state,m)k.getDerivedStateFromProps==null&&i.componentWillMount!=null&&i.componentWillMount(),i.componentDidMount!=null&&i.__h.push(i.componentDidMount);else{if(k.getDerivedStateFromProps==null&&y!==c&&i.componentWillReceiveProps!=null&&i.componentWillReceiveProps(y,w),!i.__e&&i.shouldComponentUpdate!=null&&i.shouldComponentUpdate(y,i.__s,w)===!1||t.__v===n.__v){i.props=y,i.state=i.__s,t.__v!==n.__v&&(i.__d=!1),i.__v=t,t.__e=n.__e,t.__k=n.__k,t.__k.forEach(function(L){L&&(L.__=t)}),i.__h.length&&d.push(i);break e}i.componentWillUpdate!=null&&i.componentWillUpdate(y,i.__s,w),i.componentDidUpdate!=null&&i.__h.push(function(){i.componentDidUpdate(c,l,p)})}i.context=w,i.props=y,i.state=i.__s,(f=h.__r)&&f(t),i.__d=!1,i.__v=t,i.__P=e,f=i.render(i.props,i.state,i.context),i.state=i.__s,i.getChildContext!=null&&(s=P(P({},s),i.getChildContext())),m||i.getSnapshotBeforeUpdate==null||(p=i.getSnapshotBeforeUpdate(c,l)),j=f!=null&&f.type===F&&f.key==null?f.props.children:f,se(e,Array.isArray(j)?j:[j],t,n,s,r,o,d,u,_),i.base=t.__e,t.__h=null,i.__h.length&&d.push(i),A&&(i.__E=i.__=null),i.__e=!1}else o==null&&t.__v===n.__v?(t.__k=n.__k,t.__e=n.__e):t.__e=ke(n.__e,t,n,s,r,o,d,_);(f=h.diffed)&&f(t)}catch(L){t.__v=null,(_||o!=null)&&(t.__e=u,t.__h=!!_,o[o.indexOf(u)]=null),h.__e(L,t,n)}}function de(e,t){h.__c&&h.__c(t,e),e.some(function(n){try{e=n.__h,n.__h=[],e.some(function(s){s.call(n)})}catch(s){h.__e(s,n.__v)}})}function ke(e,t,n,s,r,o,d,u){var _,f,i,m=n.props,c=t.props,l=t.type,p=0;if(l==="svg"&&(r=!0),o!=null){for(;p<o.length;p++)if((_=o[p])&&"setAttribute"in _==!!l&&(l?_.localName===l:_.nodeType===3)){e=_,o[p]=null;break}}if(e==null){if(l===null)return document.createTextNode(c);e=r?document.createElementNS("http://www.w3.org/2000/svg",l):document.createElement(l,c.is&&c),o=null,u=!1}if(l===null)m===c||u&&e.data===c||(e.data=c);else{if(o=o&&W.call(e.childNodes),f=(m=n.props||B).dangerouslySetInnerHTML,i=c.dangerouslySetInnerHTML,!u){if(o!=null)for(m={},p=0;p<e.attributes.length;p++)m[e.attributes[p].name]=e.attributes[p].value;(i||f)&&(i&&(f&&i.__html==f.__html||i.__html===e.innerHTML)||(e.innerHTML=i&&i.__html||""))}if(we(e,c,m,r,u),i)t.__k=[];else if(p=t.props.children,se(e,Array.isArray(p)?p:[p],t,n,s,r&&l!=="foreignObject",o,d,o?o[0]:n.__k&&I(n,0),u),o!=null)for(p=o.length;p--;)o[p]!=null&&ne(o[p]);u||("value"in c&&(p=c.value)!==void 0&&(p!==m.value||p!==e.value||l==="progress"&&!p)&&R(e,"value",p,m.value,!1),"checked"in c&&(p=c.checked)!==void 0&&p!==e.checked&&R(e,"checked",p,m.checked,!1))}return e}function pe(e,t,n){try{typeof e=="function"?e(t):e.current=t}catch(s){h.__e(s,n)}}function ue(e,t,n){var s,r;if(h.unmount&&h.unmount(e),(s=e.ref)&&(s.current&&s.current!==e.__e||pe(s,null,t)),(s=e.__c)!=null){if(s.componentWillUnmount)try{s.componentWillUnmount()}catch(o){h.__e(o,t)}s.base=s.__P=null}if(s=e.__k)for(r=0;r<s.length;r++)s[r]&&ue(s[r],t,typeof e.type!="function");n||e.__e==null||ne(e.__e),e.__e=e.__d=void 0}function Ce(e,t,n){return this.constructor(e,n)}function J(e,t,n){var s,r,o;h.__&&h.__(e,t),r=(s=typeof n=="function")?null:n&&n.__k||t.__k,o=[],$(t,e=(!s&&n||t).__k=a(F,null,[e]),r||B,B,t.ownerSVGElement!==void 0,!s&&n?[n]:r?null:t.firstChild?W.call(t.childNodes):null,o,!s&&n?n:r?r.__e:t.firstChild,s),de(o,e)}W=te.slice,h={__e:function(e,t){for(var n,s,r;t=t.__;)if((n=t.__c)&&!n.__)try{if((s=n.constructor)&&s.getDerivedStateFromError!=null&&(n.setState(s.getDerivedStateFromError(e)),r=n.__d),n.componentDidCatch!=null&&(n.componentDidCatch(e),r=n.__d),r)return n.__E=n}catch(o){e=o}throw e}},Y=0,ve=function(e){return e!=null&&e.constructor===void 0},z.prototype.setState=function(e,t){var n;n=this.__s!=null&&this.__s!==this.state?this.__s:this.__s=P({},this.state),typeof e=="function"&&(e=e(P({},n),this.props)),e&&P(n,e),e!=null&&this.__v&&(t&&this.__h.push(t),ie(this))},z.prototype.forceUpdate=function(e){this.__v&&(this.__e=!0,e&&this.__h.push(e),ie(this))},z.prototype.render=F,q=[],Z=typeof Promise=="function"?Promise.prototype.then.bind(Promise.resolve()):setTimeout,H.__r=0,be=0;var V={colorful:!0,always:!1,opacity:.3,wait:1e3,segments:50,threshold:300},D=JSON.parse(localStorage.getItem("bahamut-anime-comment-mountains-configs")||JSON.stringify(V));function O(e){return D[e]}function E(e,t){D[e]=t,localStorage.setItem("bahamut-anime-comment-mountains-configs",JSON.stringify(D))}function fe(){localStorage.removeItem("bahamut-anime-comment-mountains-configs");for(let e in D)V.hasOwnProperty(e)?E(e,V[e]):delete D[e]}var g={get colorful(){return O("colorful")},get always(){return O("always")},get opacity(){return O("opacity")},get wait(){return O("wait")},get segments(){return O("segments")},get threshold(){return O("threshold")},set colorful(e){e=!!e,E("colorful",e)},set always(e){e=!!e,E("always",e)},set opacity(e){e=parseFloat(e)||.3,E("opacity",e)},set wait(e){e=parseInt(e)||1e3,E("wait",e)},set segments(e){e=parseInt(e)||50,E("segments",e)},set threshold(e){e=parseInt(e)||300,E("threshold",e)}};function me(){let{canvas:e,ctx:t}=he();g.always?document.querySelector("video-js").appendChild(e):document.querySelector(".control-bar-mask").appendChild(e);let{canvas:n,ctx:s}=he();return n.style.zIndex=15,document.querySelector(".R18").appendChild(n),Se(),{canvas:e,ctx:t,preview:n,preview_ctx:s}}function he(){let e=document.createElement("canvas");Object.assign(e,{width:1e3,height:300}),Object.assign(e.style,{position:"absolute",bottom:0,left:0,width:"100%",zIndex:5,"pointer-events":"none"});let t=e.getContext("2d");return Object.assign(t,{fillStyle:"white",strokeStyle:"white",lineJoin:"round",lineCap:"round",lineWidth:2}),{canvas:e,ctx:t}}function Se(){let e=document.querySelector(".sub_top.ani-tabs"),t=document.querySelector(".ani-tab-content"),n=a("div",{id:"cm-settings",class:"ani-tabs__item"},a("a",{class:"ani-tabs-link",href:"#ani-tab-content-cm",onClick:r=>{document.querySelector(".ani-tabs-link.is-active").classList.remove("is-active"),r.target.classList.add("is-active"),document.querySelectorAll(".ani-tab-content__item").forEach(o=>{o.style.display="none"}),document.querySelector("#ani-tab-content-cm").style.display="block",r.preventDefault()}},"\u5F48\u5E55\u5C71\u8108")),s=a("div",{class:"ani-tab-content__item",id:"ani-tab-content-cm",style:"display: none"},a("div",{class:"ani-setting-section"},a("h4",{class:"ani-setting-title"},"\u5C71\u8108\u8A2D\u5B9A"),a("div",{class:"ani-setting-item ani-flex"},a("div",{class:"ani-setting-label"},a("span",{class:"ani-setting-label__mian"},"\u6301\u7E8C\u986F\u793A")),a("div",{class:"ani-setting-value ani-set-flex-right"},a("div",{class:"ani-checkbox"},a("label",{class:"ani-checkbox__label"},a("input",{id:"cm-always",type:"checkbox",name:"ani-checkbox",checked:g.always,onChange:r=>{window.cm.always=r.target.checked}}),a("div",{class:"ani-checkbox__button"}))))),a("div",{class:"ani-setting-item ani-flex"},a("div",{class:"ani-setting-label"},a("span",{class:"ani-setting-label__mian"},"\u5F69\u8272\u986F\u793A")),a("div",{class:"ani-setting-value ani-set-flex-right"},a("div",{class:"ani-checkbox"},a("label",{class:"ani-checkbox__label"},a("input",{id:"cm-colorful",type:"checkbox",name:"ani-checkbox",checked:g.colorful,onChange:r=>{window.cm.colorful=r.target.checked}}),a("div",{class:"ani-checkbox__button"}))))),a("div",{class:"ani-setting-item ani-flex"},a("div",{class:"ani-setting-label"},a("span",{class:"ani-setting-label__mian"},"\u4E0D\u900F\u660E\u5EA6"),a("span",{class:"ani-setting-label__sub",id:"cm-opacity-label"},g.opacity*100,"%")),a("div",{class:"ani-setting-value ani-set-flex-right"},a("div",{class:"ani-range",id:"cm-opacity-range"},a("input",{type:"range",id:"cm-opacity",max:"100",min:"10",step:"10",value:g.opacity*100,onChange:r=>{window.cm.opacity=parseInt(r.target.value)/100,document.querySelector("#cm-opacity-label").innerText=r.target.value+"%"}})))),a("div",{class:"ani-setting-item ani-flex"},a("div",{class:"ani-setting-label"},a("span",{class:"ani-setting-label__mian"},"\u71B1\u5EA6\u95A5\u503C"),a("span",{class:"ani-setting-label__sub",id:"cm-threshold-label"},g.threshold)),a("div",{class:"ani-setting-value ani-set-flex-right"},a("div",{class:"ani-range",id:"cm-threshold-input"},a("input",{type:"number",id:"cm-threshold",max:"1000",min:"0",step:"10",value:g.threshold,onChange:r=>{window.cm.threshold=parseInt(r.target.value),document.querySelector("#cm-threshold-label").innerText=r.target.value}})))),a("div",{class:"ani-setting-item ani-flex"},a("div",{class:"ani-setting-label"},a("span",{class:"ani-setting-label__mian"},"\u5207\u7247\u5927\u5C0F"),a("span",{class:"ani-setting-label__sub",id:"cm-segments-label"},g.segments)),a("div",{class:"ani-setting-value ani-set-flex-right"},a("div",{class:"ani-range",id:"cm-segments-input"},a("input",{type:"number",id:"cm-segments",max:"1000",min:"0",step:"10",value:g.segments,onChange:r=>{window.cm.segments=parseInt(r.target.value),document.querySelector("#cm-segments-label").innerText=r.target.value}}))))),a("style",null,'#ani-tab-content-cm input[type="number"] ',"{","border: none; color: #54c3e0; font-size: 2rem; text-align: right; ","}"));J(n,e.appendChild(document.createElement("div"))),J(s,t.appendChild(document.createElement("div")))}var K=class{constructor(t){C(this,"text","");C(this,"userid","");C(this,"color","");C(this,"position",0);C(this,"size",0);C(this,"sn",0);C(this,"time",0);Object.assign(this,t)}},U=class{constructor(t=0,n=0){C(this,"x",0);C(this,"y",0);this.x=t,this.y=n}};var b,x,T=[];(function(){return N(this,null,function*(){yield X(g.wait);let e=me();b=e.canvas,x=e.ctx,T=yield Pe(),Q(),e.preview_ctx.drawImage(b,0,0),Ne()})})();function Q(){let{max:e,heights:t}=Ee(),n=Te(t);Ae(e),Ie(),Oe(n)}function Pe(e=!1){return N(this,null,function*(){let n=(yield G(()=>fetch("https://ani.gamer.com.tw/ajax/danmuGet.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`sn=${location.search.match(/\d+/)[0]}`}).then(s=>s.json()))).map(s=>new K(s));if(S("Comments",n),e){let s=yield G(()=>fetch("https://ani.gamer.com.tw/ajax/keywordGet.php").then(r=>r.json()).then(r=>r.map(o=>o.keyword)));return n.filter(r=>!s.some(o=>r.text.includes(o)))}return n})}function Ee(){T=T.sort((o,d)=>o.time-d.time);let e=T[T.length-1].time/g.segments;S("Width",e);let t=new Array(g.segments).fill(0),n=0;for(let o=0;o<T.length;o++){for(;T[o].time>(n+1)*e+.1;)n++;t[n]++}S("Heights",t);let s=Math.max(...t);S("Max",s);let r=t.map(o=>o/s);return S("Normalized",r),{max:s,heights:r}}function Te(e){let t=[];for(let n=0;n<e.length;n++)t.push(new U(b.width/e.length*(n+.5),b.height*.5*(2-e[n])));return t}function Ae(e){let t=e-g.threshold<50?e-g.threshold:50;if(S("Color Offset",t),g.colorful){let n=x.createLinearGradient(0,b.height*.5+t,0,b.height);n.addColorStop(0,"#BF616A"),n.addColorStop(.4,"#EBCB8B"),n.addColorStop(.5,"#EBCB8B"),n.addColorStop(1,"#A3BE8C"),x.fillStyle=n}else x.fillStyle="white"}function Ie(){g.opacity?x.globalAlpha=g.opacity:x.globalAlpha=.3}function Oe(e){let t=[new U(0,b.height),...e,new U(b.width,b.height)],n=.3,s=.6,r=0,o=0,d=0,u=0,_=0;x.clearRect(0,0,b.width,b.height),x.beginPath(),x.moveTo(0,b.height);let f=t[0];for(let i=0;i<t.length;i++){let m=t[i],c=t[i+1];c?(r=(c.y-f.y)/(c.x-f.x),u=(c.x-m.x)*-n,_=u*r*s):(r=0,u=0,_=0),x.bezierCurveTo(f.x-o,f.y-d,m.x+u,m.y+_,m.x,m.y),o=u,d=_,f=m}x.lineTo(b.width,b.height),x.closePath(),x.fill()}function Ne(){window.cm={reset(){fe(),Q()}};for(let e in g)Object.defineProperty(window.cm,e,{get:()=>g[e],set:t=>{g[e]=t,e==="always"?t?document.querySelector("video-js").appendChild(b):document.querySelector(".control-bar-mask").appendChild(b):e==="wait"?S("Wait",t):Q()}})}})();
